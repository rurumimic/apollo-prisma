# Server

## Koa

`main.ts`

```ts
import app from './app'

const port: string =
  typeof process.env.PORT !== 'undefined' ? process.env.PORT : '8081'

app.listen(port, () => {
  console.log(`Server is listening on port ${port}.`)
})
```

`app.ts`

```ts
import Koa from 'koa'
import bodyParser from 'koa-bodyparser'
import session from 'koa-session'

import apollo from './graphql/apollo'

const app = new Koa()

// Session
app.keys = ['some secret key']
app.use(session(app))

// Body Parser
app.use(bodyParser())

// Middlewares
app.use(apollo.getMiddleware())

export default app
```

## Prisma

```bash
yarn database:up
yarn prisma init
```

```bash
DATABASE_URL="postgresql://master:rootpw@localhost:5432/develop?schema=public"
```

Add models to `prisma/schema.prisma`.

```prisma
model Post {
  id        Int      @default(autoincrement()) @id
  createdAt DateTime @default(now())
  title     String
  content   String?
  published Boolean  @default(false)
  author    User     @relation(fields: [authorId], references: [id])
  authorId  Int
}

model Profile {
  id     Int     @default(autoincrement()) @id
  bio    String?
  user   User    @relation(fields: [userId], references: [id])
  userId Int     @unique
}

model User {
  id      Int      @default(autoincrement()) @id
  email   String   @unique
  name    String?
  posts   Post[]
  profile Profile?
}
```

Create a seed file.

`prisma/seed.ts`

```ts
import { PrismaClient } from '@prisma/client'

const db = new PrismaClient()

main()

async function main(): Promise<void> {
  await db.user.create({
    data: {
      name: 'Alice',
      email: 'alice@prisma.io',
      posts: {
        create: { title: 'Hello World' },
      },
      profile: {
        create: { bio: 'I like turtles' },
      },
    },
  })

  const allUsers = await db.user.findMany({
    include: {
      posts: true,
      profile: true,
    },
  })
  console.dir(allUsers, { depth: null })

  db.disconnect()
}
```

```bash
yarn run prisma:save
yarn run prisma:up
yarn run seed
```

## Apollo

`src/graphql/apollo.ts`

```ts
import { ApolloServer } from 'apollo-server-koa'
import schema from './schema'
import { createContext } from './context'

const server = new ApolloServer({ schema, context: createContext })

export default server
```

## Prisma

`src/graphql/context.ts`

```ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

export interface Context {
  prisma: PrismaClient
}

export const createContext = (): Context => ({ prisma })
```

## Nexus Schema

### index.ts

`src/graphql/schema/index.ts`

```ts
import { nexusPrismaPlugin } from 'nexus-prisma'
import { makeSchema } from '@nexus/schema'
import path from 'path'

import { Query } from './Query'
import { User } from './User'

export default makeSchema({
  types: [Query, User],
  plugins: [nexusPrismaPlugin()],
  outputs: {
    typegen: path.join(
      __dirname,
      '../../../node_modules/@types/nexus-typegen/index.d.ts'
    ),
  },
  typegenAutoConfig: {
    contextType: 'Context.Context',
    sources: [
      {
        source: '.prisma/client',
        alias: 'prisma',
      },
      {
        source: require.resolve('../context'),
        alias: 'Context',
      },
    ],
  },
})
```

### Query.ts

`src/graphql/schema/Query.ts`

```ts
import { queryType } from '@nexus/schema'

export const Query = queryType({
  definition(t) {
    t.crud.users()
  },
})
```

### User.ts

`src/graphql/schema/User.ts`

```ts
import { objectType } from '@nexus/schema'

export const User = objectType({
  name: 'User',
  definition(t) {
    t.model.id()
    t.model.email()
    t.model.name()
  },
})
```

## Run Server

```bash
yarn run generate
yarn local
```

Go to `localhost:8081/graphql`.

Run a query:

```gql
query {
  users {
    id
    email
    name
  }
}
```

Result:

```json
{
  "data": {
    "users": [
      {
        "id": 1,
        "email": "alice@prisma.io",
        "name": "Alice"
      }
    ]
  }
}
```
